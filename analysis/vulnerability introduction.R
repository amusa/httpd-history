library(RODBC)
library(lattice)
conn <- odbcConnect("httpdhistory", uid="root", pwd="root", case="tolower")

repolog <- sqlQuery(conn, "SELECT * FROM VulnIntroAll")

association <- function(vulnerable, neutral){
  cat("Vuln. Mean:\t",mean(vulnerable, na.rm=TRUE),"\n")
  cat("Neutral Mean:\t",mean(neutral, na.rm=TRUE),"\n")
  wilcox.test(vulnerable,neutral)
}

###################
#### VCC Files ####
###################

#### TotalChurn####
# Do VCCs have more total churn?
vulnerable <- repolog$TotalChurn[repolog$VulnIntro=="Yes"]
neutral <- repolog$TotalChurn[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

#### RelChurn #####
# Do VCCs have more relative churn?
vulnerable <- repolog$RelativeChurn[repolog$VulnIntro=="Yes"]
neutral <- repolog$RelativeChurn[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

###### PIC ########
# Does the PIC differ between VCC and non-VCCs?
vulnerable <- repolog$PercIntChurn[repolog$VulnIntro=="Yes"]
neutral <- repolog$PercIntChurn[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

###### NAA ########
# Does the NAA differ between VCC and non-VCCs?
vulnerable <- repolog$NumAuthorsAffected[repolog$VulnIntro=="Yes"]
neutral <- repolog$NumAuthorsAffected[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

###### New Effective Author? ######
# Does being a new effective author changey our chances on having a vulnerable commit?
tbl <- table(repolog$NewEffectiveAuthor, repolog$VulnIntro, dnn=c("New Eff. Author?","VCC?"))
tbl
prop.table(tbl,1)
chisq.test(repolog$NewEffectiveAuthor, repolog$VulnIntro)

###### RecentPIC ######
vulnerable <- repolog$RecentPercIntChurn[repolog$VulnIntro=="Yes"]
neutral <- repolog$RecentPercIntChurn[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

####################
### Co-Linearity ###
####################
cor.test(repolog$TotalChurn,repolog$RelativeChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$TotalChurn,repolog$PercIntChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$TotalChurn,repolog$NumAuthorsAffected, method="kendall",na.rm=FALSE)
cor.test(repolog$TotalChurn,repolog$RecentPercIntChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$TotalChurn,repolog$RecentChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$TotalChurn,repolog$RecentAuthorsAffected, method="kendall",na.rm=FALSE)

cor.test(repolog$RelativeChurn,repolog$PercIntChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$RelativeChurn,repolog$NumAuthorsAffected, method="kendall",na.rm=FALSE)
cor.test(repolog$RelativeChurn,repolog$RecentPercIntChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$RelativeChurn,repolog$RecentChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$RelativeChurn,repolog$RecentAuthorsAffected, method="kendall",na.rm=FALSE)

cor.test(repolog$PercIntChurn,repolog$NumAuthorsAffected, method="kendall",na.rm=FALSE)
cor.test(repolog$PercIntChurn,repolog$RecentPercIntChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$PercIntChurn,repolog$RecentChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$PercIntChurn,repolog$RecentAuthorsAffected, method="kendall",na.rm=FALSE)

cor.test(repolog$NumAuthorsAffected,repolog$NumAuthorsAffected, method="kendall",na.rm=FALSE)
cor.test(repolog$NumAuthorsAffected,repolog$RecentPercIntChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$NumAuthorsAffected,repolog$RecentAuthorsAffected, method="kendall",na.rm=FALSE)

cor.test(repolog$RecentPercIntChurn,repolog$RecentChurn, method="kendall",na.rm=FALSE)
cor.test(repolog$RecentPercIntChurn,repolog$RecentAuthorsAffected, method="kendall",na.rm=FALSE)

cor.test(repolog$RecentChurn,repolog$RecentAuthorsAffected, method="kendall",na.rm=FALSE)

####################
### VCCs Grouped ###
####################

repolog <- sqlQuery(conn, "SELECT * FROM VulnIntroByCommit")

#### TotalChurn####
# Do VCCs have more total churn?
vulnerable <- repolog$TotalChurn[repolog$VulnIntro=="Yes"]
neutral <- repolog$TotalChurn[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

#### AvgRelChurn #####
# Do VCCs have more relative churn?
vulnerable <- repolog$AvgRelChurn[repolog$VulnIntro=="Yes"]
neutral <- repolog$AvgRelChurn[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

###### AvgPIC ########
# Does the PIC differ between VCC and non-VCCs?
vulnerable <- repolog$AvgPIC[repolog$VulnIntro=="Yes"]
neutral <- repolog$AvgPIC[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

###### AvgNAA ########
# Does the NAA differ between VCC and non-VCCs?
vulnerable <- repolog$AvgNAA[repolog$VulnIntro=="Yes"]
neutral <- repolog$AvgNAA[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

###### AvgNEA ########
# Does the NEA differ between VCC and non-VCCs?
vulnerable <- repolog$AvgNEA[repolog$VulnIntro=="Yes"]
neutral <- repolog$AvgNEA[repolog$VulnIntro=="No"]
association(vulnerable, neutral)

##########################
### STATUS AND CHANGES ###
##########################

vccSTATUS <- c("NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","YES","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","NO","YES","NO","NO","NO","NO","NO")
vccCHANGES <- c("YES","YES","YES","YES","YES","YES","YES","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","YES","YES","YES","NO","YES","YES","YES","YES","NO","YES","NO","NO","NO","YES","YES","NO","NO","YES","YES","YES","NO","YES","NO","YES","NO","YES","YES","NO","NO","NO","YES","NO","YES","YES","NO","NO","YES","YES","YES","YES","NO","YES","NO","NO","YES","NO","NO","NO","YES","NO","NO","YES","NO","NO","NO","YES","NO","NO","YES","NO","NO","NO","YES","YES","NO","NO","NO","YES","YES","NO","NO","NO","NO","NO","YES","YES","NO","NO","NO","NO","NO","NO","NO","YES")
vccEITHER <- c("YES","YES","YES","YES","YES","YES","YES","YES","NO","YES","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","YES","YES","YES","YES","NO","YES","YES","YES","YES","NO","YES","NO","NO","NO","YES","YES","NO","NO","YES","YES","YES","NO","YES","YES","YES","NO","YES","YES","NO","NO","NO","YES","NO","YES","YES","NO","NO","YES","YES","YES","YES","NO","YES","NO","NO","YES","NO","NO","NO","YES","NO","NO","YES","NO","NO","NO","YES","NO","YES","YES","NO","NO","NO","YES","YES","NO","NO","NO","YES","YES","NO","NO","NO","NO","NO","YES","YES","NO","NO","YES","NO","NO","NO","NO","YES")

nonVccSTATUS <- c("YES","NO","NO","NO","NO","YES","YES","YES","NO","YES","NO","YES","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","NO","NO","YES","NO","YES","YES","NO","NO","YES","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","YES","NO","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO")
nonVccCHANGES <- c("YES","YES","NO","YES","NO","YES","YES","YES","YES","NO","NO","YES","NO","YES","YES","YES","YES","NO","NO","YES","NO","NO","YES","YES","YES","NO","YES","YES","NO","NO","YES","YES","NO","YES","YES","YES","NO","NO","NO","NO","YES","YES","NO","NO","NO","YES","NO","YES","NO","YES","YES","NO","NO","NO","YES","NO","NO","YES","NO","NO","YES","NO","YES","NO","NO","NO","YES","YES","NO","YES","NO","NO","YES","NO","YES","YES","YES","NO","NO","NO","NO","YES","YES","NO","NO","NO","NO","NO","NO","YES","YES","NO","NO","NO","NO","NO","NO","YES","YES","NO","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","YES","YES","NO","YES","NO","YES","YES","YES","YES","NO","YES","NO","NO","YES","YES","NO","YES","NO","NO","YES","YES","NO","YES","NO","NO","NO","NO")
nonVccEITHER <- c("YES","YES","NO","YES","NO","YES","YES","YES","YES","YES","NO","YES","NO","YES","YES","YES","YES","NO","NO","YES","NO","NO","YES","YES","YES","NO","YES","YES","NO","NO","YES","YES","NO","YES","YES","YES","NO","NO","YES","NO","YES","YES","NO","NO","YES","YES","NO","YES","NO","YES","YES","NO","NO","NO","YES","NO","NO","YES","NO","NO","YES","NO","YES","NO","NO","NO","YES","YES","NO","YES","NO","NO","YES","NO","YES","YES","YES","NO","NO","NO","NO","YES","YES","NO","NO","NO","NO","YES","NO","YES","YES","NO","NO","NO","NO","NO","NO","YES","YES","NO","NO","NO","YES","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","NO","YES","NO","NO","YES","YES","NO","YES","NO","YES","YES","YES","YES","NO","YES","NO","NO","YES","YES","NO","YES","NO","NO","YES","YES","NO","YES","NO","NO","NO","NO")

eitherSTATUSorCHANGE <- read.csv2("c:/local/data/httpd/qualitative-status-or-changes.csv", header=TRUE)
chisq.test(table(eitherSTATUSorCHANGE))



####################
### Histogram!!! ###
####################

# SELECT 
#    c2g.CVE, 
#    c2g.filepath,
#    c2g.CommitIntroduced, 
#    r1.authordate,
#    CommitFixed,
#    r2.authordate,
#    TIMESTAMPDIFF(DAY, r1.authordate,r2.authordate)    
# FROM cvetogit c2g, repolog r1, repolog r2
# WHERE c2g.CommitIntroduced != 'N/A'
#  AND c2g.CommitIntroduced=r1.commit
#  AND c2g.Filepath=r1.Filepath
#  AND c2g.CommitFixed=r2.commit
#  AND c2g.Filepath=r2.Filepath

timecounts <- sqlQuery(conn, "SELECT c2g.CVE, c2g.filepath, c2g.CommitIntroduced, r1.authordate, CommitFixed, r2.authordate, TIMESTAMPDIFF(DAY, r1.authordate,r2.authordate) Exposure FROM cvetogit c2g, repolog r1, repolog r2 WHERE c2g.CommitIntroduced != 'N/A' AND c2g.CommitIntroduced=r1.commit AND c2g.Filepath=r1.Filepath AND c2g.CommitFixed=r2.commit AND c2g.Filepath=r2.Filepath")
mean(timecounts$Exposure)
median(timecounts$Exposure)
hist(timecounts$Exposure, breaks=20, col="red", main="HTTPD Exposure", freq=TRUE, xlab="Days between VCC and fix", labels=FALSE, axes=FALSE)
axis(side=1, at=seq(0,4000, 365), labels=seq(0,4000,365))
axis(side=2, at=seq(0,20, 5), labels=seq(0,20,5))

length(timecounts$Exposure[timecounts$Exposure < 365]) / length(timecounts$Exposure)
length(timecounts$Exposure[timecounts$Exposure < 30]) / length(timecounts$Exposure)
length(timecounts$Exposure[timecounts$Exposure > 3650]) / length(timecounts$Exposure)



#odbcClose(conn)
#rm(conn)